#!/usr/bin/env python3
import os
import sys
import time
from datetime import datetime
from dotenv import load_dotenv  # pip install python-dotenv
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_community.tools import ShellTool
from langchain.agents import initialize_agent

# ---------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------
load_dotenv()  # Loads GOOGLE_API_KEY from .env file
GOOGLE_KEY = os.getenv("GOOGLE_API_KEY")
if not GOOGLE_KEY:
    sys.exit("‚ùå GOOGLE_API_KEY not found. Create a .env file with GOOGLE_API_KEY=<key>")

# LLM setup
llm = ChatGoogleGenerativeAI(
    model="gemini-2.5-flash",
    temperature=0,
    google_api_key=GOOGLE_KEY
)

# Tool to run Linux commands
shell_tool = ShellTool()

# Initialize the agent with verbose off by default
agent = initialize_agent(
    tools=[shell_tool],
    llm=llm,
    verbose=False
)

LOG_FILE = "output.log"


def log_result(text: str) -> None:
    """Append timestamped text to output.log."""
    with open(LOG_FILE, "a") as f:
        f.write(f"\n[{datetime.now().isoformat()}]\n{text}\n")


def show_sysstats():
    """Quick built-in Linux stats without LLM."""
    import shutil, psutil  # psutil needs to be installed
    mem = psutil.virtual_memory()
    cpu = psutil.cpu_percent(interval=1)
    disk = shutil.disk_usage("/")
    print(f"CPU usage: {cpu}%")
    print(f"RAM used: {mem.used // (1024**2)} MB / {mem.total // (1024**2)} MB")
    print(f"Disk free: {disk.free // (1024**3)} GB / {disk.total // (1024**3)} GB")


def main():
    print("=== Personalized Linux AI ===")
    print("Type 'exit' or 'quit' to leave. Type 'sysstats' for quick system info.\n")

    while True:
        user_prompt = input("Enter your requirement: ").strip()
        if user_prompt.lower() in {"exit", "quit"}:
            print("Goodbye!")
            break

        if user_prompt.lower() == "sysstats":
            show_sysstats()
            continue

        input_message = {
            "role": "user",
            "content": (
                "You are a Linux administrator. "
                "Give only the final command output (no extra explanation). "
                f"Append the result to {LOG_FILE}. Prompt: {user_prompt}"
            )
        }

        try:
            result = agent.run({"input": input_message})
            print(result)
            log_result(f"Prompt: {user_prompt}\n{result}")
        except Exception as e:
            err_msg = f"Error: {e}"
            print(err_msg)
            log_result(err_msg)


if __name__ == "__main__":
    main()
